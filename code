#include <WiFi.h>
#include <ESP32Servo.h>

const char* ssid = "LAB";  
const char* password = "tt1234tt";  

WiFiServer server(80);

// ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ Servos ÎºÎ±Î¹ LED
Servo headServo, eyesServo, mouthServo;
const int headPin = 8;   // ÎšÎµÏ†Î¬Î»Î¹
const int eyesPin = 9;  // ÎœÎ¬Ï„Î¹Î±
const int mouthPin = 10; // Î£Ï„ÏŒÎ¼Î±
const int ledPin = 2;    // LED (Î§Î­ÏÎ¹)

int headAngle = 90;
int eyesAngle = 90;
int mouthAngle = 0;
bool handUp = false; // LED Î±ÏÏ‡Î¹ÎºÎ¬ ÏƒÎ²Î·ÏƒÏ„ÏŒ (Î§Î­ÏÎ¹ ÎºÎ¬Ï„Ï‰)

void setup() {
    Serial.begin(115200);
    delay(5000);
    WiFi.begin(ssid, password);
    Serial.print("Connecting to WiFi...");

    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }

    Serial.println("\nConnected to WiFi");
    Serial.print("Server IP: ");
    Serial.println(WiFi.localIP());

    server.begin();
    Serial.println("Server started...");

    headServo.attach(headPin);
    eyesServo.attach(eyesPin);
    mouthServo.attach(mouthPin);

    pinMode(2, OUTPUT);
    digitalWrite(2, LOW); // Î§Î­ÏÎ¹ ÎºÎ¬Ï„Ï‰ Î±ÏÏ‡Î¹ÎºÎ¬
}

void loop() {
    WiFiClient client = server.available();
    
    if (client) {
        Serial.println("Client Connected");
        String request = client.readStringUntil('\r');
        Serial.println("Request: " + request);
        client.flush();

        // Î‘Î½Ï„Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÎšÎµÏ†Î±Î»Î¹Î¿Ï (0Â° = Î”ÎµÎ¾Î¹Î¬, 180Â° = Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ¬)
        if (request.indexOf("/set?head=") >= 0) {
            int val = request.substring(request.indexOf("=") + 1, request.indexOf("&")).toInt();
            if (val >= 0 && val <= 180) {
                headAngle = 180 - val;  // ğŸ”„ Î‘Î½Ï„Î¹ÏƒÏ„ÏÎ¿Ï†Î® Ï„Î¹Î¼Î®Ï‚
                headServo.write(headAngle);
                Serial.print("ÎšÎµÏ†Î¬Î»Î¹ (Î”ÎµÎ¾Î¹Î¬/Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ¬): ");
                Serial.println(headAngle);
            }
        } 
        // Î‘Î½Ï„Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÎœÎ±Ï„Î¹ÏÎ½ (0Â° = Î”ÎµÎ¾Î¹Î¬, 180Â° = Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ¬)
        if (request.indexOf("eyes=") >= 0) {
            int val = request.substring(request.indexOf("eyes=") + 5, request.indexOf("&", request.indexOf("eyes="))).toInt();
            if (val >= 0 && val <= 180) {
                eyesAngle = 180 - val;  // ğŸ”„ Î‘Î½Ï„Î¹ÏƒÏ„ÏÎ¿Ï†Î® Ï„Î¹Î¼Î®Ï‚
                eyesServo.write(eyesAngle);
                Serial.print("ÎœÎ¬Ï„Î¹Î± (Î”ÎµÎ¾Î¹Î¬/Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ¬): ");
                Serial.println(eyesAngle);
            }
        } 
        // ÎšÎ¯Î½Î·ÏƒÎ· Î£Ï„ÏŒÎ¼Î±Ï„Î¿Ï‚ (0Â° = ÎšÎ»ÎµÎ¹ÏƒÏ„ÏŒ, 90Â° = Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ)
        if (request.indexOf("mouth=") >= 0) {
            int val = request.substring(request.indexOf("mouth=") + 6, request.indexOf("&", request.indexOf("mouth="))).toInt();
            if (val >= 0 && val <= 90) {  
                mouthAngle = val;
                mouthServo.write(mouthAngle);
                Serial.print("Î£Ï„ÏŒÎ¼Î± (Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ/ÎšÎ»ÎµÎ¹ÏƒÏ„ÏŒ): ");
                Serial.println(mouthAngle);
            }
        }
        // LED (Î§Î­ÏÎ¹ Î Î¬Î½Ï‰/ÎšÎ¬Ï„Ï‰)
        if (request.indexOf("hand=up") >= 0) {
            handUp = true;
            digitalWrite(ledPin, HIGH);
            Serial.println("Î§Î­ÏÎ¹ Î Î¬Î½Ï‰ (LED ON)");
        } 
        if (request.indexOf("hand=down") >= 0) {
            handUp = false;
            digitalWrite(ledPin, LOW);
            Serial.println("Î§Î­ÏÎ¹ ÎšÎ¬Ï„Ï‰ (LED OFF)");
        }

        // HTML Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î¼Îµ ÏƒÏ‰ÏƒÏ„Î¬ labels
        client.println("HTTP/1.1 200 OK");
        client.println("Content-Type: text/html");
        client.println("Connection: close");
        client.println();
        client.println("<!DOCTYPE html><html><head>");
        client.println("<meta charset=\"UTF-8\">");
        client.println("<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">");
        client.println("<title>Classmate Assistant</title>");
        client.println("<style> body { font-family: Arial; text-align: center; margin-top: 50px; } ");
        client.println("input { width: 300px; } button { font-size: 20px; margin: 10px; padding: 10px; } </style></head><body>");
        client.println("<h2>Classmate Assistant</h2>");

        // Sliders Î³Î¹Î± Ï„Î± Servos
        client.println("<p>ÎšÎµÏ†Î¬Î»Î¹ (Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ¬/Î”ÎµÎ¾Î¹Î¬): <span id=\"angle1\"></span>Â°</p>");
        client.println("<input type=\"range\" min=\"0\" max=\"180\" value=\"" + String(180 - headAngle) + "\" id=\"head\" oninput=\"sendAngle('head', this.value)\">");
        
        client.println("<p>ÎœÎ¬Ï„Î¹Î± (Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ¬/Î”ÎµÎ¾Î¹Î¬): <span id=\"angle2\"></span>Â°</p>");
        client.println("<input type=\"range\" min=\"0\" max=\"180\" value=\"" + String(180 - eyesAngle) + "\" id=\"eyes\" oninput=\"sendAngle('eyes', this.value)\">");
        
        client.println("<p>Î£Ï„ÏŒÎ¼Î± (Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ/ÎšÎ»ÎµÎ¹ÏƒÏ„ÏŒ): <span id=\"angle3\"></span>Â°</p>");
        client.println("<input type=\"range\" min=\"0\" max=\"90\" value=\"" + String(mouthAngle) + "\" id=\"mouth\" oninput=\"sendAngle('mouth', this.value)\">");

        // LED ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ (Î§Î­ÏÎ¹ Ï€Î¬Î½Ï‰ / ÎºÎ¬Ï„Ï‰)
        client.println("<p><button onclick=\"sendHand('up')\">Î§Î­ÏÎ¹ Î Î¬Î½Ï‰</button>");
        client.println("<button onclick=\"sendHand('down')\">Î§Î­ÏÎ¹ ÎšÎ¬Ï„Ï‰</button></p>");

        // JavaScript Î³Î¹Î± AJAX ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±
        client.println("<script>");
        client.println("function sendAngle(part, angle) {");
        client.println("document.getElementById('angle' + (part == 'head' ? 1 : part == 'eyes' ? 2 : 3)).innerText = angle;");
        client.println("var xhttp = new XMLHttpRequest();");
        client.println("xhttp.open('GET', '/set?' + part + '=' + angle, true);");
        client.println("xhttp.send(); }");

        client.println("function sendHand(state) {");
        client.println("var xhttp = new XMLHttpRequest();");
        client.println("xhttp.open('GET', '/set?hand=' + state, true);");
        client.println("xhttp.send(); }");
        client.println("</script>");

        client.println("</body></html>");

        client.stop();
        Serial.println("Client Disconnected");
    }
}
